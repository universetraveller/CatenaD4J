<project name="Mockito" basedir="${basedir}">

    <!-- Force build in Java 1.7 for older versions of the project -->
    <property name="build.compiler" value="javac1.7"/>
    <property name="junit.jar" value="${script.dir}/build-scripts/lib/junit-4.11.jar"/>

    <!-- Check for an existing build.xml, should only exist in older commits -->
    <available file="${basedir}/build.xml" property="ant.exists"/>

    <!-- Check the "how to build" file to see if we should use ant or gradlew -->
    <condition property="use.gradle">
        <resourcecontains resource="${basedir}/HOWTO.BUILD.TXT" substring="> gradlew build"/>
    </condition>

    <!-- There is a period where ant build exists, but we want to use gradle anyways -->
    <condition property="use.ant">
        <and>
            <istrue value="${ant.exists}"/>
            <isfalse value="${use.gradle}"/>
        </and>
    </condition>

    <!-- Location of compiled classes changes in older builds -->
    <condition property="test.home" value="${basedir}/target/test-classes" else="${basedir}/build/classes/test">
        <istrue value="${use.ant}"/>
    </condition>
    <condition property="classes.dir" value="${basedir}/target/classes" else="${basedir}/build/classes/main">
        <istrue value="${use.ant}"/>
    </condition>
    <condition property="test.src.home" value="${basedir}/src/test" else="${basedir}/test">
        <istrue value="${use.ant}"/>
    </condition>
    <property name="test.classes.dir" value="${test.home}" />

    <condition property="build.home" value="${basedir}/target" else="${basedir}/build">
        <istrue value="${use.ant}"/>
    </condition>

    <path id="compile.classpath">
        <pathelement path="${classes.dir}"/>
        <fileset dir="${d4j.home}/framework/projects/${d4j.project.id}/lib/">
            <include name="**/*.jar" />
        </fileset>
        <fileset dir="${basedir}/compileLib/">
            <include name="**/*.jar" />
        </fileset>
    </path>

    <path id="d4j.test.classpath">
        <pathelement path="${junit.jar}"/>
        <pathelement path="${classes.dir}"/>
        <pathelement path="${test.home}"/>
        <fileset dir="${d4j.home}/framework/projects/${d4j.project.id}/lib/">
            <include name="**/*.jar" />
        </fileset>
        <fileset dir="${basedir}/compileLib/">
            <include name="**/*.jar" />
        </fileset>
    </path>

    <target name="get-deps">
        <mkdir dir="${basedir}/compileLib"/>
        <!--
        too slow! it took 432 ms
        <exec executable="/bin/bash" failonerror="true" outputproperty="bytebuddy.version">
            <arg value="-c"/>
            <arg value="grep 'byte-buddy' ${basedir}/build.gradle | grep -oE ':[0-9]+\.[0-9]+\.[0-9]+' | head -1 | cut -c2-"/>
        </exec>
        -->
        <loadfile property="gradle.line" srcFile="${basedir}/build.gradle"/>
        <propertyregex
            input="${gradle.line}"
            property="bytebuddy.version"
            regexp="byte-buddy:([0-9]+\.[0-9]+\.[0-9]+)"
            select="\1"/>
        <if>
            <available file="${d4j.home}/framework/projects/Mockito/byte-buddy/byte-buddy-${bytebuddy.version}.jar"/>
            <then>
                <copy file="${d4j.home}/framework/projects/Mockito/byte-buddy/byte-buddy-${bytebuddy.version}.jar"
                    todir="${basedir}/compileLib"/>
            </then>
        </if>
    </target>

    <property name="c4j.before-get-cp" value="get-deps" />

    <property name="c4j.tests.getter.predict" value=".*Test$" />

    <!-- List of all developer-written tests that reliably pass on the fixed version -->
    <fileset id="all.manual.tests" dir="${basedir}/${d4j.dir.src.tests}" excludes="${d4j.tests.exclude}">
        <include name="**/*Test.java"/>
        <exclude name="**/Abstract*.java"/>
        <exclude name="**/GitHubTicketFetcherTest*"/>
    </fileset>

    <fileset id="c4j.projects.mockito.dir.mockmaker" dir="${basedir}/mockmaker/bytebuddy/test/java" excludes="${d4j.tests.exclude}" erroronmissingdir="false">
        <include name="**/*Test.java"/>
        <exclude name="**/Abstract*.java"/>
        <exclude name="**/GitHubTicketFetcherTest*"/>
    </fileset>

    <property name="c4j.tests.getter.predict.extra_files" value="c4j.projects.mockito.dir.mockmaker" />

    <!-- List of relevant developer-written tests that reliably pass on the fixed version -->
    <fileset id="rel.manual.tests" dir="${test.home}"
        includesfile="${d4j.home}/framework/projects/${d4j.project.id}/relevant_tests/${d4j.bug.id}" />

</project>
